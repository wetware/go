# Wetware Cell API Specification

## Motivation

The Wetware Cell API defines the interface between a host process (running `ww run`) and a cell process (child process managed by `ww run`) that runs in a controlled execution environment with attenuated capabilities.

This document is for users who want to write their own cells. Simply adhere to this specification, and then you can `ww run <yourbinary>`, and your application will run in a secure, decentralized environment with access to capabilities like IPFS.

## Process Interface

### Standard Input/Output
- **stdin (fd 0)**: Direct passthrough from host's stdin
- **stdout (fd 1)**: Direct passthrough to host's stdout  
- **stderr (fd 2)**: Direct passthrough to host's stderr

### Command Line Arguments
- **argv[0]**: Executable path
- **argv[1..n]**: Arguments passed from host to cell
- Arguments are passed through unchanged from host's `exec.Command`

### Environment Variables
- **WW_ENV**: Comma-separated list of environment variables to pass to cell
- Additional environment variables can be specified via `--env` flag
- Cell inherits host's environment filtered by these specifications

## File Descriptors

### Extra File Descriptors
- **fd 3**: One end of a Unix domain socket pair for Cap'n Proto RPC communication with host
- **fd 4**: Binary file containing cell's Ed25519 private key (PEM format)

### File Descriptor Usage
The cell process must:
1. Read its identity from fd 4
2. Establish RPC connection via fd 3
3. Authenticate using the identity to obtain capabilities

## Capabilities

### Available Capabilities
Currently, exactly one capability is available:

- **IPFS**: Access to IPFS Core API
  - Interface: `system.IPFS` (Cap'n Proto)
  - Access: Policy-controlled based on authentication
  - Scope: Determined by host's IPFS configuration

### Future Capabilities
The interface is designed to support additional capabilities:
- Process execution
- Network access (via libp2p streams)
- Various decentralized services

## Authentication

### Identity Format
- **Type**: Ed25519 private key
- **Encoding**: PEM format
- **Source**: Freshly generated by host for each cell execution

### Authentication Protocol
1. Host generates 16-byte nonce challenge
2. Cell signs nonce with its private key
3. Host verifies signature against allowed public key
4. Host grants capabilities based on verification result

## Status Codes

### Standard Exit Codes
- **0**: Success
- **1**: General error
- **2**: Usage error
- **126**: Command not executable
- **127**: Command not found
- **128+n**: Signal termination (n = signal number)

### Future Standard Codes
The following status codes are reserved for future standardization:
- **64**: Cell authentication failed
- **65**: Capability access denied
- **66**: Resource limit exceeded
- **67**: Isolation violation detected

## Reference Implementations

### ww run
The `ww run` subcommand is a reference implementation that demonstrates the cell API. It:
- Creates a jailed execution environment
- Generates fresh Ed25519 credentials for the cell
- Sets up the Unix domain socket pair for RPC communication
- Launches the specified executable with the required file descriptors

### ww shell
The `ww shell` subcommand is a reference implementation that runs an interactive shell within a cell. It:
- Uses `ww run` to create a cell running the same `ww` binary
- Executes the `shell membrane` subcommand within that cell
- The `membrane` subcommand authenticates with the host and creates a REPL
- Provides an interactive shell with access to cell capabilities
- Demonstrates how to build interactive applications that interact with the cell session

### membrane Subcommand
Both `ww run` and `ww shell` use the `membrane` subcommand as the cell entry point. This subcommand:
- Is part of the `ww` binary itself (not a separate executable)
- Handles the cell-side authentication and capability negotiation
- Provides the interface between the cell environment and the host's capabilities

## Security Model

### Process Isolation
- **Filesystem**: Chroot jail (when available)
- **Namespaces**: PID, UTS, mount, network, IPC isolation (Linux)
- **Privileges**: Dropped to unprivileged user
- **Host Death**: Automatic termination on host exit

### Capability Security
- **One-time Authentication**: Fresh credentials per execution
- **Policy-based Access**: Authorization through policy objects
- **Attenuated Capabilities**: Limited access to host resources
- **Cryptographic Verification**: Digital signature-based authentication 